#!/bin/bash

##########################################################
# [02-12-17] 
# + Started as a copy of elast_lite/submit.h10_2_delastR-sim_lite
# + Usage elast_lite/submit.h10_2_delastR-sim_lite-e16
###########################################################
date=`date +%m%d%y`

EXP='e16'
DTYP='exp'

PROCORDER="eid:efid:pcorr:evtsel_elast:"
#! ADTNL_OPTS=BASIC_ADTNL_OPTS from 'h10_2_per_non_vst_results.py'
ADTNL_OPTS=":1:3:17:2:18:20:" #! ECin-on:zvtx-on:eff_scpd_atmod:ECfid-ON:ECfid_atmod_ON:CC_cut_lse:

PROJECT_NAME="E1-6a"
MEMORY_SPACE="2000"
TIME="70"
MSSDIR=$E16D_EI
SUBDIR=$BSUBDIR/e16/elast/exp/h10_2_delastR_$date
OUTDIR=$DELASTDIR_EXP_E16/delast_$date/byRun
OUTDIR_LOG=$OUTDIR/log
if [[ ! -d $OUTDIR_LOG ]]; then
    mkdir -p $OUTDIR_LOG
fi
H10LSTDIR_RZ=${HOME}/ongoing/e16_EI_lst/rz
H10LSTDIR_ROOT=${HOME}/ongoing/e16_EI_lst/root
H10LSTDIR=$H10LSTDIR_RZ

echo "*** Info setup for jsub.xml and proc_h10_lite ***"
echo "PROCORDER=$PROCORDER"
echo "ADTNL_OPT=$ADTNL_OPT"
echo "PROJECT_NAME=$PROJECT_NAME"
echo "MEMORY_SPACE=$MEMORY_SPACE"
echo "TIME=$TIME"
echo "MSSDIR=$MSSDIR"
echo "SUBDIR=$SUBDIR"
echo "OUTDIR=$OUTDIR"
echo "OUTDIR_LOG=$OUTDIR_LOG"
echo "H10LSTDIR=$H10LSTDIR"

mkdir -p $SUBDIR
mkdir -p $OUTDIR

for h10lst in $(ls  $H10LSTDIR/*.lst);
do
  runnum=$(echo $h10lst | awk -F/ '{print $7}' | awk -F. '{print $1}')
  JSUBFILE=$SUBDIR/$runnum.sub
  if [ -f "${JSUBFILE}" ]; then
    echo $runnum".sub exists. Will delete it before creating new one."
    rm $JSUBFILE
  fi

  echo "\
  <Request>
    <Name name=\"$EXP"_h10_2_delastR-exp_"$runnum\"/>
    <Project name=\"$PROJECT_NAME\"/>
    <OS name=\"centos65\"/>
    <DiskSpace space=\"500\" unit=\"MB\"/>
    <Memory space=\"$MEMORY_SPACE\" unit=\"MB\"/>
    <Track name=\"analysis\"/>
    <TimeLimit unit=\"minutes\" time=\"$TIME\"/>
    <Command><![CDATA[
      ah2root_e16
      check_e16_h10lst
      proc_h10_lite -i h10.lst -t $EXP:$DTYP:elast:recon -c $PROCORDER -o delastR.root $ADTNL_OPT
    ]]></Command>

    <Job>
        <Input src=\"$H10LSTDIR_ROOT/$runnum".lst"\" dest=\"h10.lst\" />
        `for f in $(cat $h10lst)
         do
           echo \<Input src='"'mss:$MSSDIR/$f'"' dest='"'$f'"' /\> 
         done`
        <Output src=\"delastR.root\" dest=\"$OUTDIR/$runnum.root\"/>
        <Output src=\"job.out\" dest=\"$OUTDIR_LOG/$runnum.out\"/>
        <Output src=\"job.err\" dest=\"$OUTDIR_LOG/$runnum.err\"/>
    </Job>

  </Request>
  " > $JSUBFILE 
  echo "jsub -xml $JSUBFILE"
  jsub -xml $JSUBFILE
done
