#!/bin/bash

##########################################################
# [03-02-15]
# + Get h10.lst files for all E1F Runs from ${HOME}/ongoing/e1f_allruns_h10lst
# and submit h10->delastR jobs for each of them.
# + The h10.lst files contain just the root file names for each Run, therefore
# this script additionally appends the full /mss path to the files and lists them
# as separate input files for the job
# [08-10-15]
# Usage submit.h10_2_delastR-exp proc_opt
###########################################################

##-- Get proc_opt and simlist from user specified args
proc_opt=$1
if [ $proc_opt = "dflt"* ];then
  adtnl_cut_opt=""
elif [[ $proc_opt == "eid_all__eid_IU_all"* ]];then
  adtnl_cut_opt="1:2:3:4:5:6"
elif [[ $proc_opt == "eid_ECin"* ]];then
  adtnl_cut_opt="1:"
elif [[ $proc_opt == "eid_ECfid"* ]];then
  adtnl_cut_opt="2:"
elif [[ $proc_opt == "eid_zvtx"* ]];then
  adtnl_cut_opt="3:"
elif [[ $proc_opt == "eid_etot"* ]];then
  adtnl_cut_opt="4:"
elif [[ $proc_opt == "eid_all"* ]];then
  adtnl_cut_opt="1:2:3:4:"
elif [[ $proc_opt == "eid_IU_no_SChit"* ]];then
  adtnl_cut_opt="5:"
elif [[ $proc_opt == "eid_IU_no_dc_stat"* ]];then
  adtnl_cut_opt="6:"
elif [[ $proc_opt == "eid_IU_all"* ]];then
  adtnl_cut_opt="5:6:"
else
  echo "proc_opt=$proc_opt not recognized. Exiting."
  exit
fi
echo "proc_opt=$proc_opt"
echo "adtnl_cut_opt=$adtnl_cut_opt"

date=`date +%m%d%y`
SUBDIR=$BSUBDIR_E1F_ELAST_EXP/h10_2_delastR-exp-byRun_e_lite_$proc_opt"_"$date
if [[ ! -d ${SUBDIR} ]]; then
    mkdir -p $SUBDIR
fi
OUTDIR=$DELASTDIR_EXP/byRun_lite_$proc_opt"_"$date
if [[ ! -d $OUTDIR ]]; then
    mkdir -p $OUTDIR
fi
OUTDIR_LOG=$OUTDIR/log
if [[ ! -d $OUTDIR_LOG ]]; then
    mkdir -p $OUTDIR_LOG
fi

for h10lst in $(ls  ${HOME}/ongoing/e1f_goldenruns_h10lst_e/*.lst);
do
  runnum=$(echo $h10lst | awk -F/ '{print $6}' | awk -F. '{print $1}')
  JSUBFILE=$SUBDIR/$runnum.sub
  if [ -f "${JSUBFILE}" ]; then
    echo $runnum".sub exists. Will delete it before creating new one."
    rm $JSUBFILE
  fi

  echo "\
  <Request>
    <Name name=\"e1f_h10_2_delastR-exp_lite_$proc_opt"_"$runnum\"/>
    <Project name=\"E1F\"/>
    <OS name=\"centos65\"/>
    <DiskSpace space=\"500\" unit=\"MB\"/>
    <Memory space=\"500\" unit=\"MB\"/>
    <Track name=\"analysis\"/>
    <TimeLimit unit=\"minutes\" time=\"600\"/>
    <Command><![CDATA[
      proc_h10_lite -i h10.lst -t e1f:exp:recon -o delastR.root $adtnl_cut_opt
    ]]></Command>

    <Job>
        <Input src=\"$h10lst\" dest=\"h10.lst\" />
        `for f in $(cat $h10lst)
         do
           echo \<Input src='"'mss:$E1FD_E/$f'"' dest='"'$f'"' /\> 
         done`
        <Output src=\"delastR.root\" dest=\"$OUTDIR/$runnum.root\"/>
        <Output src=\"job.out\" dest=\"$OUTDIR_LOG/$runnum.out\"/>
        <Output src=\"job.err\" dest=\"$OUTDIR_LOG/$runnum.err\"/>
    </Job>

  </Request>
  " > $JSUBFILE 
  echo "jsub -xml $JSUBFILE"
  jsub -xml $JSUBFILE
done
