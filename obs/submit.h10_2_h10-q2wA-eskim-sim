#!/bin/bash
##-----------------------------------------------##
# Usage submit.h10-q2wA-eskimR-sim sim1 sim2 ... simX
##-----------------------------------------------##

##-- Get list of simnum from user
simlist=("$@")
echo "Going to submit h10-q2wA-eskimR-sim for the following"
for simnum in "${simlist[@]}"; do
   echo "$simnum"
done

##-- Now submit jobs for each simnum
for simnum in "${simlist[@]}"; do
  date=`date +%m%d%y`

  SUBDIR=${BSUBDIR}/e1f/2pi/sim/h10-q2wA-eskimR-sim-$simnum/$date
  OUTDIR=$H10DIR_SIM/"$simnum"_h10-q2wA-eskim/
  OUTDIR_R=$H10DIR_SIM/"$simnum"_h10-q2wA-eskim/R_$date
  OUTDIR_T=$H10DIR_SIM/"$simnum"_h10-q2wA-eskim/T_$date
  mkdir -p $SUBDIR
  mkdir -p $OUTDIR
  mkdir -p $OUTDIR_R
  mkdir -p $OUTDIR_T 
 
  for runnum in $(ls  $H10DIR_SIM/$simnum/recon/*.root); 
  do
    runnum=`basename $runnum`
    runnum=$(echo $runnum | awk -F. '{print $1}')
    echo $runnum
    #! prepare h10.lst
    ls $H10DIR_SIM/$simnum/recon/$runnum.root > $SUBDIR/h10_$runnum.lst
 
    JSUBFILE=${SUBDIR}/job_$runnum.sub
    if [ -f "${JSUBFILE}" ]; then
      echo "$JSUBFILE exists. Will delete it before creating new one."
      rm $JSUBFILE
    fi

    echo "\
    <Request>
      <Name name=\"e1f_h10-q2wA-eskimR-sim\"/>
      <Project name=\"E1F\"/>
      <OS name=\"centos65\"/>
      <DiskSpace space=\"5000\" unit=\"MB\"/>
      <Memory space=\"9500\" unit=\"MB\"/>
      <Track name=\"analysis\"/>
      <TimeLimit unit=\"minutes\" time=\"5\"/>
      <Command><![CDATA[
        proc_h10 -i h10.lst -t e1f:sim:2pi -p eid:efid:q2wskimR_A:copyh10 -o outputR.root
        proc_h10 -i h10.lst -t e1f:sim:2pi -p q2wskimT_A:copyh10          -o outputT.root
      ]]></Command>

      <Job>
        <Input src=\"$SUBDIR/h10_$runnum.lst\" dest=\"h10.lst\" />
        <Output src=\"outputR.root\" dest=\"$OUTDIR_R/$runnum.root\"/>
        <Output src=\"outputT.root\" dest=\"$OUTDIR_T/$runnum.root\"/>
      </Job>

    </Request>
    " > $JSUBFILE 
    echo "jsub -xml $JSUBFILE"
    jsub -xml $JSUBFILE
  done
done
